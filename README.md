# Welcome to Coconutsplit
#
Coconutsplit is a Telegram bot built with [pyTelegramBotAPI](https://pytba.readthedocs.io/en/latest/).

## Directory Structure

```plaintext
/coconutsplit
│
├── /bot                     # Bot logic
│   ├── main.py              # Main bot script
│   ├── classes.py           # Class types
│   ├── handlers.py          # Custom message handlers
│
├── /web-app                 # Web app folder
│   ├── index.html           # Web app HTML
│   ├── style.css            # Styling
│   ├── script.js            # Web app logic
│
├── .env                     # Environment variables (bot token, etc.)
├── .gitignore               # Ignoring sensitive files (.env, .venv)
├── /venv                    # Virtual environment
│   └── ...
├── requirements.txt         # Python dependencies
├── client.py                # Setup Supabase client
├── Procfile                 # Logic for Heroku deployment
└── README.md                # Project documentation
```

## Database Schema

The following database schema outlines the structure used in Supabase to store user and expense data for the CoconutSplit bot.

### Users Table

Stores information about the users.

```sql
CREATE TABLE users (
    uuid UUID PRIMARY KEY,
    user_id BIGINT,
    username TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    currency TEXT DEFAULT 'SGD'
);
```

| Column      | Type      | Description                          |
| ----------- | --------- | ------------------------------------ |
| `uuid`      | UUID      | Unique identifier for the user        |
| `user_id`   | BIGINT    | Telegram ID of user                   |
| `username`  | TEXT      | The user's display name or username   |
| `created_at`| TIMESTAMP | The time when the user was created    |
| `currency`  | TEXT      | The user's preferred currency (optional) |

---

### Groups Table

Stores information about the groups users create.

```sql
CREATE TABLE groups (
    group_id UUID PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    group_name TEXT NOT NULL,
    created_by UUID REFERENCES users(uuid),
    created_at TIMESTAMP DEFAULT NOW(),
    chat_id BIGINT UNIQUE;
);
```

| Column       | Type      | Description                          |
| ------------ | --------- | ------------------------------------ |
| `group_id`   | UUID    | Unique identifier for the group      |
| `group_name` | TEXT      | The name of the group                |
| `created_by` | UUID      | UUID of the user who created the group |
| `created_at` | TIMESTAMP | The time when the group was created  |
| `chat_id` | BIGINT | Chat ID of the chat in which the group was created  |

---

### Group Members Table

Stores the relationship between users and groups.

```sql
CREATE TABLE group_members (
    group_id UUID REFERENCES groups(group_id),
    user_uuid UUID REFERENCES users(uuid),
    joined_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (group_id, user_id)
);
```

| Column      | Type      | Description                          |
| ----------- | --------- | ------------------------------------ |
| `group_id`  | UUID    | UUID of the group                      |
| `user_uuid`   | UUID    | UUID of the user                       |
| `joined_at` | TIMESTAMP | Time when the user joined the group  |

---

### Expenses Table

Stores information about the expenses created in each group.

```sql
CREATE TABLE expenses (
    expense_id UUID PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    group_id UUID REFERENCES groups(group_id),
    paid_by UUID REFERENCES users(uuid),
    amount DECIMAL(10, 2) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

| Column       | Type      | Description                          |
| ------------ | --------- | ------------------------------------ |
| `expense_id` | UUID    | Unique identifier for the expense    |
| `group_id`   | UUID    | UUID of the group                      |
| `paid_by`    | UUID    | UUID of the user who paid              |
| `amount`     | DECIMAL   | Total amount of the expense          |
| `description`| TEXT      | Description of the expense           |
| `created_at` | TIMESTAMP | Time when the expense was created    |

---

### Expense Splits Table

Stores how expenses are split among group members.

```sql
CREATE TABLE debts (
    group_id UUID REFERENCES groups(group_id),
    user_id UUID REFERENCES users(uuid),   -- The user who owes money
    opp_user_id UUID REFERENCES users(uuid), -- The user to whom money is owed
    amount_owed DECIMAL(10, 2),
    PRIMARY KEY (group_id, user_id, opposing_user_id)
);
```

| Column        | Type      | Description                          |
| ------------- | --------- | ------------------------------------ |
| `expense_id`  | UUID    | UUID of the expense                    |
| `user_uuid`     | UUID    | UUID of the user who owes              |
| `opp_user_uuid`     | UUID    | UUID of the user who is owed              |
| `amount_owed` | DECIMAL   | Amount owed by the user              |

---

### Settlements Table

Tracks payments made between users to settle debts.

```sql
CREATE TABLE settlements (
    settlement_id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    from_user UUID REFERENCES users(uuid),
    to_user UUID REFERENCES users(uuid),
    amount DECIMAL(10, 2),
    group_id BIGINT REFERENCES groups(group_id),
    created_at TIMESTAMP DEFAULT NOW()
);
```

| Column         | Type      | Description                          |
| -------------- | --------- | ------------------------------------ |
| `settlement_id`| UUID    | Unique identifier for the settlement |
| `from_user`    | UUID    | UUID of the payer                 |
| `to_user`      | UUID    | UUID of the recipient             |
| `amount`       | DECIMAL   | Amount settled                      |
| `group_id`     | UUID    | UUID of the group (optional)           |
| `created_at`   | TIMESTAMP | Time when the settlement was created |

## User Flow Chart
```mermaid
graph TD
    A[/Start/] --> B[Bot lists main commands]
    
    B --> C[/User sends /create_group/]
    C --> D[Bot asks for group name]
    D --> E[User inputs group name]
    E --> EE[Bot asks for tax amount]
    EE --> EEE[User inputs tax amount]
    EEE --> F[Bot creates group]
    F --> G[Bot sends Join button]
    G --> H[User clicks Join button]
    H --> I[Bot adds user to group]
    I --> J[Bot confirms user joined]

    B --> K[/User sends /add_credit/]
    K --> L[Bot asks for group]
    L --> M[User selects group]
    M --> MA[Bot asks for expense name]
    MA --> MB[User inputs expense name]
    MB --> MC[Bot asks if tax applies]
    MC --> MD[User replies yes/no]
    MD --> N[Bot asks for amount & desc]
    N --> O[User inputs amount & desc]
    O --> P[Bot asks who paid and how much]
    P --> Q[User inputs payer and amount]
    Q --> R[Bot confirms expense]

    B --> S[/User sends /split_equally/]
    S --> SA[Bot asks for group]
    SA --> SB[User selects group]
    SB --> T[Bot asks for expense name]
    T --> TI[User inputs expense name]
    TI --> TJ[Bot asks if tax applies]
    TJ --> TA[User replies yes/no]
    TA --> TC[Bot asks for amount and description]
    TC --> TE[User inputs amount and description]
    TE--> TF[Bot asks for users to split amongst]
    TF --> TG[User inputs users]
    TG --> TH[Bot confirms expense]

    B --> U[/User sends /view_balance/]
    U --> V[Bot shows balances]

    B --> W[/User sends /settle_debt/]
    W --> X[Bot asks for group & user]
    X --> Y[User selects group & user]
    Y --> Z[Bot asks for amount]
    Z --> AA[User inputs amount]
    AA --> AB[Bot confirms settlement]

    B --> AC[/User sends /help/]
    AC --> AD[Bot lists commands]
```

## UML Class Diagram

```mermaid

classDiagram
    class User {
        - int user_id
        - string username
        - string uuid
        - datetime created_at
        - string currency = "SGD"
        + save_to_db(): void
        + fetch_from_db_by_user_id(user_id: int): User
        + fetch_from_db_by_uuid(uuid: string): User
    }
    
    class Group {
        - string group_id
        - string group_name
        - User created_by
        - int chat_id
        - datetime created_at
        + save_to_db(): void
        + add_member(user: User): void
        + fetch_from_db_by_chat(chat_id: int): Group
        + delete_from_db(): void
        + check_user_in_group(user: User): bool
        + remove_member(user: User): void
        + fetch_all_members(): List[User]
    }

    class Expense {
        - string expense_id
        - Group group
        - User paid_by
        - float amount
        - string description
        - datetime created_at
        + save_to_db(): void
        + add_debt(user: User, amount_owed: float): void
        + add_debt_reverse(user: User, amount_owed: float): void
        + fetch_expenses_by_group(group: Group): List~Expense~
    }

    class Settlement {
        - string settlement_id
        - User from_user
        - User to_user
        - float amount
        - Group group
        - datetime created_at
        + save_to_db(): void
    }

    User "1" --> "*" Group : creates, belongs to
    Group "1" --> "*" Expense : has
    Expense "1" --> "*" User : paid by
    Group "1" --> "*" Settlement : has
    Settlement "1" --> "*" User : involves
```
## Classes

### `User` Class

The `User` class is responsible for handling user-related data and actions within the CoconutSplit bot. Each `User` object represents a user interacting with the bot, identified by their Telegram `user_id`.

#### Attributes:
- `user_id` (int): The unique Telegram ID of the user.
- `username` (str): The Telegram username of the user.
- `uuid` (str): A UUID generated for the user, used as the primary key in the database.
- `currency` (str): The preferred currency of the user (default is "SGD").
- `created_at` (datetime): Timestamp when the user was created.

#### Methods:

- **`save_to_db()`**:
  Saves the `User` object to the database, including the `user_id`, `username`, `uuid`, and other details.

- **`fetch_from_db_by_user_id(user_id: int)`**:
  Static method that fetches a user from the database based on their Telegram `user_id`. If found, it returns a `User` object.

- **`fetch_from_db_by_uuid(uuid: str)`**:
  Static method that fetches a user from the database using their UUID. If found, it returns a `User` object.

---

### `Group` Class

The `Group` class represents a group created within the CoconutSplit bot. Groups can have multiple members and track expenses shared among them. Each group is associated with a specific Telegram chat, meaning only one group can exist per chat.

#### Attributes:
- `group_id` (str): A unique UUID for the group, generated if not provided.
- `group_name` (str): The name of the group.
- `created_by` (User): The user who created the group.
- `chat_id` (int): The Telegram chat ID where the group was created.
- `created_at` (datetime): Timestamp when the group was created.

#### Methods:

- **`save_to_db()`**:
  Saves the `Group` object to the database, including the `group_id`, `group_name`, `created_by`, and `chat_id`.

- **`add_member(user: User)`**:
  Adds a `User` to the group and saves the relationship to the database. This checks if the user is already part of the group before adding.

- **`fetch_all_members()`**:
  Fetches and returns a list of all members of the group from the database.

- **`fetch_from_db_by_chat(chat_id: int)`**:
  Static method that retrieves a `Group` object from the database using the `chat_id` of the Telegram chat where the group was created.

- **`delete_from_db()`**:
  Deletes the group and all related data (members, expenses, splits) from the database.

- **`remove_member(user: User)`**:
  Removes a specific `User` from the group by deleting the entry from the `group_members` table in the database.

---
### `Expense` Class

The `Expense` class represents an expense created within a group in the CoconutSplit bot. Each expense records the total amount, who paid, and the splits among group members.

#### Attributes:
- `expense_id` (str): A unique UUID for the expense, generated if not provided.
- `group` (Group): The group in which the expense was created.
- `paid_by` (User): The user who paid the expense.
- `amount` (float): The total amount of the expense.
- `description` (str): A short description of the expense.
- `created_at` (datetime): Timestamp when the expense was created.

#### Methods:

- **`save_to_db()`**:  
  Saves the `Expense` object to the database, including the `expense_id`, `group_id`, `paid_by`, `amount`, and `description`.

- **`add_debt(user: User, amount_owed: float)`**:  
  Adds an entry to the `debts` table, representing how much a user owes for this specific expense. If a split already exists between the user and the payer for the given group, the method updates the existing record instead of creating a new one.

- **`add_debt_reverse(user: User, amount_owed: float)`**:  
  Adds a reverse entry to the `debts` table, recording how much the payer is owed by the user. Similar to `add_debt()`, this method updates the existing record if necessary.

- **`fetch_expenses_by_group(group: Group)`**:  
  A static method that retrieves all expenses associated with a given group from the database and returns a list of `Expense` objects. This includes fetching details like who paid for the expense and the amount.
---